@using NodeDev.Core;
@using NodeDev.Core.Class;
@using System.Reactive.Linq;

@using BlazorMonaco
@using BlazorMonaco.Editor
@using BlazorMonaco.Languages

<style>
    .sourceViewer, .sourceViewer > .mud-tabs-panels {
    width: 100%;
    height: 100%
    }
</style>

@if (Method == null || CodeCs == null)
{
    <MudText Typo="Typo.caption">Open a method to view its generated source code</MudText>
}
else
{
    <MudTabs Class="sourceViewer">
        <MudTabPanel Text="Generated C#" Class="wh100">
            <StandaloneCodeEditor @key="CodeCs.GetHashCode().ToString()" ConstructionOptions="@(x => EditorConstructionOptions(x, CodeCs, "csharp"))" CssClass="wh100" />
        </MudTabPanel>
        <MudTabPanel Text="IL Code" Class="wh100">
            <MudText Typo="Typo.body1" Style="padding: 16px;">IL code viewer will be added in a future update.</MudText>
        </MudTabPanel>
    </MudTabs>
}

@code {
    [Parameter]
    public NodeClassMethod? Method { get; set; }

    [Parameter]
    public bool IsVisible { get; set; }

    private NodeClassMethod? PreviousMethod { get; set; }

    private IDisposable? GraphChangedSubscription { get; set; }

    private string? CodeCs;

    private StandaloneEditorConstructionOptions EditorConstructionOptions(StandaloneCodeEditor editor, string code, string language)
    {
        return new()
            {
                ReadOnly = true,
                Value = code,
                Language = language,
                AutomaticLayout = true,
                Minimap = new()
                {
                    Enabled = false
                }
            };
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        if (!IsVisible)
            return;

        // Either the target method changed or it previously failed to compile
        if (Method != PreviousMethod)
        {
            if (Method?.Graph.Project != PreviousMethod?.Graph.Project)
            {
                GraphChangedSubscription?.Dispose();

                if (Method != null)
                    GraphChangedSubscription = Method.Graph.Project.GraphChanged.Where(x => x.Graph == Method?.Graph).AcceptThenSample(TimeSpan.FromSeconds(1)).Delay(TimeSpan.FromSeconds(1)).Subscribe(x => InvokeAsync(() => OnGraphChanged(x.Graph)));
            }

            PreviousMethod = Method;
            CodeCs = null; // we don't want to leave the code from the previous method visible

            if (Method != null)
                OnGraphChanged(Method.Graph);
        }
    }

    private void OnGraphChanged(Graph graph)
    {
        ArgumentNullException.ThrowIfNull(Method);

        try
        {
            var temp = Path.Combine(Path.GetTempPath(), Guid.NewGuid().ToString());
            var assemblyPath = Method.Graph.Project.Build(Core.BuildOptions.Debug with { OutputPath = temp });

            // Get the generated C# code from the project
            CodeCs = Method.Graph.Project.GetGeneratedCSharpCode(Method);

            if (CodeCs != null)
            {
                CodeCs = $"// Generated code from NodeDev visual programming{System.Environment.NewLine}// This is the actual C# code that gets compiled and executed{System.Environment.NewLine}{System.Environment.NewLine}{CodeCs}";
            }
            else
            {
                CodeCs = "// Unable to retrieve generated code for this method";
            }

            StateHasChanged();
        }
        catch (BuildError buildError)
        {
            CodeCs = $"/* Error during code generation of node {buildError.Node.Name}: {System.Environment.NewLine}{buildError.Message}{System.Environment.NewLine}";

            if (buildError.InnerException != null)
                CodeCs += $"{System.Environment.NewLine}Inner exception:{System.Environment.NewLine}{buildError.InnerException}";

            CodeCs += $"{System.Environment.NewLine}*/";
        }
        catch (Exception ex)
        {
            CodeCs = $"/* Error during code generation: {System.Environment.NewLine}{ex}{System.Environment.NewLine}*/";
        }
    }
}
