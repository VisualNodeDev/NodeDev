@using Microsoft.AspNetCore.Components.Forms
@using NodeDev.Blazor.Services
@using NodeDev.Core
@implements IDisposable
@inject ProjectService ProjectService
@inject ISnackbar Snackbar
@inject AppOptionsContainer AppOptionsContainer
@inject IDialogService DialogService


<MudButton OnClick="Open" Class="ml-3" Disabled=@Project.IsLiveDebuggingEnabled data-test-id="open-project">Open</MudButton>
<MudButton OnClick="NewProject" Class="ml-3" Disabled=@Project.IsLiveDebuggingEnabled data-test-id="newProject">New Project</MudButton>
<MudButton OnClick="Save" Class="ml-3" data-test-id="save">Save</MudButton>
<MudButton OnClick="SaveAs" Class="ml-3" data-test-id="saveAs">Save As</MudButton>
<MudButton OnClick="Build" Class="ml-3" data-test-id="build-project">Build</MudButton>
<MudButton OnClick="Run" Class="ml-3" data-test-id="run-project" Color="@(Project.IsHardDebugging ? Color.Warning : Color.Default)" Disabled="@Project.IsHardDebugging">@(Project.IsHardDebugging ? "Running (Debugging)" : "Run")</MudButton>
<MudButton OnClick="Export" Class="ml-3" data-test-id="export-project">Export</MudButton>
<MudButton OnClick="Add" Class="ml-3">Add node</MudButton>
<MudButton OnClick="RunWithDebug" Class="ml-3" data-test-id="run-with-debug" Color="@(Project.IsHardDebugging ? Color.Warning : Color.Info)" Disabled="@Project.IsHardDebugging">
	@if (Project.IsHardDebugging)
	{
		<MudIcon Icon="@Icons.Material.Filled.BugReport" Class="mr-1" />
		<span>Debugging (PID: @Project.DebuggedProcessId)</span>
	}
	else
	{
		<MudIcon Icon="@Icons.Material.Filled.BugReport" Class="mr-1" />
		<span>Run with Debug</span>
	}
</MudButton>
<MudButton OnClick="SwitchLiveDebugging">@(Project.IsLiveDebuggingEnabled ? "Stop Live Debugging" : "Start Live Debugging")</MudButton>
<MudButton OnClick="ToggleBreakpoint" Class="ml-3" data-test-id="toggle-breakpoint" Title="Toggle Breakpoint (F9)">
    <MudIcon Icon="@Icons.Material.Filled.FiberManualRecord" Color="Color.Error" Size="Size.Small" />
</MudButton>
<MudSpacer />
<MudButton OnClick="OpenOptionsDialogAsync" Class="ml-3" data-test-id="options">Options</MudButton>
<MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" Edge="Edge.End" />


@code {

    [CascadingParameter]
    public NodeDev.Blazor.Index? IndexPage { get; set; }

    private Project Project => ProjectService.Project;

	private DialogOptions DialogOptions => new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };

    private IDisposable? HardDebugStateSubscription;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // Subscribe to hard debug state changes to refresh UI
        HardDebugStateSubscription = Project.HardDebugStateChanged.Subscribe(_ =>
        {
            InvokeAsync(StateHasChanged);
        });
    }

    public void Dispose()
    {
        HardDebugStateSubscription?.Dispose();
    }

    private Task Open()
    {
        return DialogService.ShowAsync<OpenProjectDialog>("Open Project", DialogOptions);
    }

    private Task Save()
    {
        if (string.IsNullOrWhiteSpace(Project.Settings.ProjectName))
        {
            return SaveAs();
        }

        try
        {
            ProjectService.SaveProjectToFile();
            Snackbar.Add("Project saved", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        
		return Task.CompletedTask;
    }

	private Task SaveAs()
	{
        return DialogService.ShowAsync<SaveAsProjectDialog>("Save As Project", DialogOptions);
	}

    private void NewProject()
    {
        ProjectService.ChangeProject(Core.Project.CreateNewDefaultProject());
    }

    private void Add()
    {
        //GraphCanvas?.ShowAddNode();
    }

    public void Run()
    {
        new Thread(() =>
        {
            Project.Run(Project.IsLiveDebuggingEnabled ? Core.BuildOptions.Debug : Core.BuildOptions.Release);
        }).Start();
    }

    public void RunWithDebug()
    {
        new Thread(() =>
        {
            try
            {
                Project.RunWithDebug(Core.BuildOptions.Debug);
            }
            catch (Exception ex)
            {
                // Show error dialog on UI thread
                InvokeAsync(async () =>
                {
                    await DialogService.ShowMessageBox(
                        "Debug Attachment Failed",
                        ex.Message,
                        yesText: "OK");
                });
            }
        }).Start();
    }

    public void Build()
    {
        try
        {
            Project.Build(Core.BuildOptions.Debug);
            Snackbar.Add("Project built successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Build failed: {ex.Message}", Severity.Error);
        }
    }

    public void Export()
    {
        try
        {
            // Export functionality - for now, just show a message
            Snackbar.Add("Export functionality not yet implemented", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
    }

    private void SwitchLiveDebugging()
    {
        if (Project.IsLiveDebuggingEnabled)
            Project.StopLiveDebugging();
        else
            Project.StartLiveDebugging();
    }

    private void ToggleBreakpoint()
    {
        IndexPage?.ToggleBreakpointOnSelectedNode();
    }

    private Task OpenOptionsDialogAsync()
    {
        return DialogService.ShowAsync<OptionsDialog>("Options", DialogOptions);
    }
}
